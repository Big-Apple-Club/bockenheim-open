<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bockenheim Open 2025</title>
    <!-- Einbindung von LeafletJS für die interaktive Karte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Google Fonts für eine passende Schriftart -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6b33; /* Dunkles Golfgrün */
            --secondary-color: #f5f5f5; /* Helles Grau für Hintergründe */
            --accent-color: #d4af37; /* Gold-Akzent für wichtige Elemente */
            --text-color: #333333;
            --card-bg: #ffffff;
            --danger-color: #c62828; /* Rot für Warnungen */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background-color: var(--primary-color);
            /* Subtiles Muster für mehr Tiefe */
            background-image: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.05) 25%, transparent 25%),
                linear-gradient(225deg, rgba(255, 255, 255, 0.05) 25%, transparent 25%),
                linear-gradient(45deg, rgba(255, 255, 255, 0.05) 25%, transparent 25%),
                linear-gradient(315deg, rgba(255, 255, 255, 0.05) 25%, var(--primary-color) 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: repeat;
            color: white;
            text-align: center;
            padding: 3rem 1rem 4rem; /* Mehr Padding für den neuen Look */
            /* Dynamischere Form */
            clip-path: polygon(0 0, 100% 0, 100% 85%, 50% 100%, 0 85%);
            margin-bottom: -3rem;
            position: relative;
            z-index: 10;
        }

        .header h1 {
            margin: 0;
            font-size: clamp(2.5rem, 8vw, 4rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            /* Verbesserter Textschatten für mehr Pop */
            text-shadow: 3px 3px 10px rgba(0,0,0,0.5);
            animation: fadeInDown 1s ease-out;
        }

        .header p {
            margin: 0.5rem 0 0;
            font-size: clamp(1rem, 4vw, 1.2rem);
            opacity: 0.9;
            font-weight: 700; /* Etwas dicker für bessere Lesbarkeit */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary-color);
        }

        h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
        }

        .stop {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            background-color: #fafafa;
            border: 1px solid #eee;
        }
        
        .stop-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stop h3 { margin: 0; font-size: 1.2rem; }
        .drink { font-style: italic; color: #555; }
        .par {
            font-weight: 900;
            font-size: 2.5rem;
            color: var(--primary-color);
            line-height: 1;
        }
        .par span {
            font-size: 1rem;
            font-weight: 400;
            display: block;
            color: #777;
        }

        #current-challenge-card {
            display: none;
            text-align: center;
            border-color: var(--accent-color);
            background-color: #fffbef;
        }
        #current-challenge-card h2 { font-size: 1.5rem; }
        #current-challenge-card p { font-size: 1.2rem; margin: 0.5rem 0; }
        #current-challenge-card .par { font-size: 3rem; margin-top: 1rem; }
        .stop.active {
            background-color: #fffbef;
            border-left: 5px solid var(--accent-color);
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        ul.rules-list {
            list-style: none;
            padding: 0;
        }
        ul.rules-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        ul.rules-list li:last-child {
            border-bottom: none;
        }
        ul.rules-list .penalty {
            font-weight: 700;
            font-size: 1.2rem;
        }
        ul.rules-list .penalty.positive { color: #c62828; }
        ul.rules-list .penalty.negative { color: #2e7d32; }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
        }

        td.team-name {
            font-weight: bold;
            text-align: left;
        }

        td.total {
            font-weight: 900;
            background-color: #e8f5e9;
            font-size: 1.1rem;
        }
        
        /* Countdown and Timer Styles */
        .countdown, .timer {
            text-align: center;
        }
        .countdown-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        .countdown-item {
            background: var(--secondary-color);
            padding: 10px;
            border-radius: 10px;
            min-width: 80px;
        }
        .countdown-item span {
            display: block;
        }
        .countdown-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .countdown-label {
            font-size: 0.9rem;
            color: #777;
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 900;
            color: var(--primary-color);
            margin: 10px 0;
        }
        .timer-controls button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .timer-controls button:hover {
            background-color: #0a5227;
            transform: translateY(-2px);
        }
        .timer-controls button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
        
        .admin-panel {
            background-color: var(--text-color);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }

        .admin-panel h2, .admin-panel h3 { color: white; border-color: var(--accent-color); }
        .admin-panel input, .admin-panel select, .admin-panel button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
            box-sizing: border-box;
        }
        .admin-panel button {
            background-color: var(--accent-color);
            color: var(--text-color);
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .admin-panel button:hover { transform: scale(1.02); }
        #admin-content { display: none; }

        .admin-panel button.danger-button {
            background-color: var(--danger-color);
            color: white;
        }
         .admin-panel button.danger-button:hover {
            background-color: #a32222;
        }
        .admin-panel button.confirm-button {
            background-color: #ff3d00; /* Bright orange/red */
            color: white;
        }

    </style>
</head>
<body>

<header class="header">
    <h1>Bockenheim Open</h1>
    <p>Hostet by BAC / Basalt WG</p>
</header>

<main class="container">
    
    <section class="card countdown">
        <h2>Tour Start</h2>
        <div id="countdown-container" class="countdown-container">
            <div class="countdown-item"><span id="days" class="countdown-number">0</span><span class="countdown-label">Tage</span></div>
            <div class="countdown-item"><span id="hours" class="countdown-number">0</span><span class="countdown-label">Stunden</span></div>
            <div class="countdown-item"><span id="minutes" class="countdown-number">0</span><span class="countdown-label">Minuten</span></div>
            <div class="countdown-item"><span id="seconds" class="countdown-number">0</span><span class="countdown-label">Sekunden</span></div>
        </div>
        <p id="countdown-message" style="font-weight: bold; margin-top: 15px;"></p>
    </section>

    <section class="card" id="current-challenge-card">
        <h2>AKTUELLE CHALLENGE</h2>
        <div id="current-challenge-content">
            <p>Der Admin hat die Tour noch nicht gestartet.</p>
        </div>
    </section>

    <section class="card">
        <h2>Die Route & Karte</h2>
        <div id="map"></div>
    </section>
    
    <section class="card">
        <h2>Die 9 Löcher (Tour-Plan)</h2>
        <div id="stops-list"></div>
    </section>

    <section class="card">
        <h2>Live Leaderboard</h2>
        <div style="overflow-x:auto;">
            <table id="leaderboard">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Strafen</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section class="card">
        <h2>Regelwerk</h2>
        <ul class="rules-list">
            <li>Getränk verschüttet <span class="penalty positive">+2</span></li>
            <li>Hole-in-One (auf ex getrunken) <span class="penalty negative">-1</span></li>
            <li>Loch nicht beendet <span class="penalty positive">+3</span></li>
            <li>Nicht mit dem Partner getrunken (1x Joker) <span class="penalty positive">+3</span></li>
            <li>Party-Hut abgenommen <span class="penalty positive">+1</span></li>
        </ul>
    </section>

    <section class="card timer">
        <h2>10-Sekunden Ex-Counter</h2>
        <div id="timer-display" class="timer-display">10.0</div>
        <div class="timer-controls">
            <button id="timer-start">Start</button>
            <button id="timer-reset">Reset</button>
        </div>
    </section>

    <section class="admin-panel">
        <h2>Admin-Steuerung</h2>
        <div id="login-section">
            <p>Passwort eingeben, um Scores zu verwalten.</p>
            <input type="password" id="admin-password" placeholder="Admin-Passwort">
            <button onclick="unlockAdmin()">Freischalten</button>
        </div>
        <div id="admin-content">
            <h3>Scores pro Loch</h3>
            <label for="score-team-select">Team auswählen:</label>
            <select id="score-team-select"></select>
            <label for="hole-select">Loch auswählen:</label>
            <select id="hole-select"></select>
            <label for="score-input">Benötigte Schlücke:</label>
            <input type="number" id="score-input" placeholder="Anzahl">
            <button onclick="updateScore()">Score eintragen</button>

            <hr style="margin: 20px 0; border-color: #555;">

            <h3>Strafen & Boni</h3>
            <label for="penalty-team-select">Team auswählen:</label>
            <select id="penalty-team-select"></select>
            <label for="penalty-select">Regel auswählen:</label>
            <select id="penalty-select"></select>
            <button onclick="applyPenalty()">Strafe/Bonus anwenden</button>

            <hr style="margin: 20px 0; border-color: #555;">

            <h3>Tour-Steuerung</h3>
            <label for="current-stop-select">Aktuellen Stopp festlegen:</label>
            <select id="current-stop-select"></select>
            <button onclick="setCurrentStop()">Als aktuellen Stopp setzen</button>

            <hr style="margin: 20px 0; border-color: #555;">
            
            <h3>Gefahrenzone</h3>
            <button id="reset-button" class="danger-button" onclick="requestFullReset()">ALLES ZURÜCKSETZEN</button>
            <button id="cancel-reset-button" style="display:none; background-color: #555; color: white;" onclick="cancelReset()">Abbrechen</button>
        </div>
    </section>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
        // TODO: Add your Firebase configuration here
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tourConfig = {
        stops: [
            { name: "Start: Basaltstraße 39", lat: 50.1259278, lon: 8.6441328, drink: "Long-Drink", par: 4, address: "Basaltstraße 39" },
            { name: "Dalli Dalli Pilsstübchen", lat: 50.1256647, lon: 8.6436847, drink: "Bier/Appler", par: 3, address: "Grempstraße 4" },
            { name: "Lüsterweibchen", lat: 50.1241143, lon: 8.6414999, drink: "Wein", par: 3, address: "Große Seestraße 49a" },
            { name: "Kiosk am Platz", lat: 50.1244439, lon: 8.6434939, drink: "Shot", par: 1, address: "Kurfürstenpl. 36" },
            { name: "Casa Blanca", lat: 50.1198891, lon: 8.6450849, drink: "Cocktail / Longdrink", par: 4, address: "Adalbertstraße 34" },
            { name: "Zum Tannenbaum", lat: 50.1189258, lon: 8.6463081, drink: "Appler", par: 3, address: "Adalbertstraße 53" },
            { name: "Khan Kiosk", lat: 50.1198055, lon: 8.6487065, drink: "Bier/Appler", par: 3, address: "Leipziger Str. 2" },
            { name: "Extrablatt", lat: 50.1198957, lon: 8.6504733, drink: "Shot", par: 1, address: "Bockenheimer Warte" },
            { name: "Doctor Flotte", lat: 50.1204769, lon: 8.65017, drink: "Bier / Appler / Wein", par: 3, address: "Leipziger Str. 20" }
        ],
        teams: ["Team Alpha", "Team Bravo", "Team Charlie", "Team Delta", "Team Echo", "Team Foxtrot"],
        adminPassword: "bockenheim",
        rules: [
            { text: "Getränk verschüttet", value: 2 },
            { text: "Hole-in-One (Exen)", value: -1 },
            { text: "Loch nicht beendet", value: 3 },
            { text: "Partner-Regel missachtet", value: 3 },
            { text: "Party-Hut abgenommen", value: 1 }
        ]
    };

    let scores = {};
    let mapMarkers = [];
    let currentStopIndex = -1;

    document.addEventListener('DOMContentLoaded', () => {
        initCountdown();
        initExCounter();
        initMap();
        initStopsList();
        initLeaderboard();
        initAdminPanel();
        loadScores();
        loadStopFromStorage();

        setInterval(async () => {
            const snapshot = await get(ref(db, 'currentStop'));
            const updatedIndex = snapshot.val();
            if (updatedIndex !== null && parseInt(updatedIndex, 10) !== currentStopIndex) {
                currentStopIndex = parseInt(updatedIndex, 10);
                updateCurrentStopView(true);
            }
            await loadScores(); // Scores auch regelmäßig laden
        }, 2500);
    });

    function initCountdown() {
        const now = new Date();
        const saturday = new Date(now);
        saturday.setDate(now.getDate() + (6 - now.getDay() + 7) % 7); // Find the next Saturday
        saturday.setHours(21, 0, 0, 0);
        const targetDate = saturday.getTime();

        const countdownInterval = setInterval(() => {
            const currentTime = new Date().getTime();
            const distance = targetDate - currentTime;

            if (distance < 0) {
                clearInterval(countdownInterval);
                document.getElementById('countdown-container').style.display = 'none';
                document.getElementById('countdown-message').textContent = 'Die Bockenheim Open haben begonnen! Viel Erfolg!';
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById('days').textContent = days;
            document.getElementById('hours').textContent = hours;
            document.getElementById('minutes').textContent = minutes;
            document.getElementById('seconds').textContent = seconds;
        }, 1000);
    }
    
    let exTimerInterval;
    function initExCounter() {
        const startBtn = document.getElementById('timer-start');
        const resetBtn = document.getElementById('timer-reset');
        const display = document.getElementById('timer-display');
        
        startBtn.addEventListener('click', () => {
            startBtn.disabled = true;
            let endTime = Date.now() + 10000;

            exTimerInterval = setInterval(() => {
                const timeLeft = endTime - Date.now();
                if (timeLeft <= 0) {
                    clearInterval(exTimerInterval);
                    display.textContent = "0.0";
                    startBtn.disabled = false;
                    return;
                }
                display.textContent = (timeLeft / 1000).toFixed(1);
            }, 100);
        });

        resetBtn.addEventListener('click', () => {
            clearInterval(exTimerInterval);
            display.textContent = "10.0";
            startBtn.disabled = false;
        });
    }

    function initMap() {
        const map = L.map('map').setView([50.123, 8.646], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

        const routeCoordinates = tourConfig.stops.map(stop => [stop.lat, stop.lon]);

        tourConfig.stops.forEach((stop, index) => {
            const holeNum = index + 1;
            const icon = L.divIcon({
                html: `<div style="background-color: var(--primary-color); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${holeNum}</div>`,
                className: '', iconSize: [30, 30], iconAnchor: [15, 15]
            });
            const marker = L.marker([stop.lat, stop.lon], { icon }).addTo(map)
                .bindPopup(`<b>Loch ${holeNum}: ${stop.name}</b><br>${stop.address}<br><i>Getränk: ${stop.drink}</i><br><b>Par: ${stop.par}</b>`);
            mapMarkers.push(marker);
        });

        L.polyline(routeCoordinates, { color: 'var(--primary-color)', weight: 4, opacity: 0.8 }).addTo(map);
    }
    
    function initStopsList() {
        const stopsListElement = document.getElementById('stops-list');
        stopsListElement.innerHTML = '';
        tourConfig.stops.forEach((stop, index) => {
            const holeNum = index + 1;
            const stopElement = document.createElement('div');
            stopElement.className = 'stop';
            stopElement.id = `stop-list-item-${index}`; 
            stopElement.innerHTML = `
                <div class="stop-info">
                    <div><h3>${holeNum}. ${stop.name}</h3><p class="drink">Getränk: ${stop.drink}</p></div>
                    <div class="par">${stop.par}<span>PAR</span></div>
                </div>`;
            stopsListElement.appendChild(stopElement);
        });
    }

    function initLeaderboard() {
        const leaderboardHeader = document.querySelector("#leaderboard thead tr");
        leaderboardHeader.innerHTML = '<th>Rang</th><th>Team</th>'; // Spalte für Rang hinzugefügt
        for (let i = 1; i <= tourConfig.stops.length; i++) {
            const th = document.createElement('th'); th.textContent = `${i}`; leaderboardHeader.appendChild(th);
        }
        leaderboardHeader.innerHTML += '<th>Strafen</th><th>Total</th>';

        tourConfig.teams.forEach(team => {
            if (!scores[team]) {
                scores[team] = { holes: Array(tourConfig.stops.length).fill(0), penalty: 0 };
            }
        });
    }

    function initAdminPanel() {
        const scoreTeamSelect = document.getElementById("score-team-select");
        const penaltyTeamSelect = document.getElementById("penalty-team-select");
        const holeSelect = document.getElementById("hole-select");
        const currentStopSelect = document.getElementById("current-stop-select");
        const penaltySelect = document.getElementById("penalty-select");

        [scoreTeamSelect, penaltyTeamSelect, holeSelect, currentStopSelect, penaltySelect].forEach(el => el.innerHTML = '');

        tourConfig.teams.forEach(team => {
            const option = document.createElement("option"); option.value = team; option.textContent = team;
            scoreTeamSelect.appendChild(option.cloneNode(true));
            penaltyTeamSelect.appendChild(option);
        });

        tourConfig.stops.forEach((stop, index) => {
            const option = document.createElement("option"); option.value = index; option.textContent = `Loch ${index + 1}: ${stop.name}`;
            holeSelect.appendChild(option.cloneNode(true));
            currentStopSelect.appendChild(option);
        });
        
        tourConfig.rules.forEach(rule => {
            const option = document.createElement("option"); option.value = rule.value; option.textContent = `${rule.text} (${rule.value > 0 ? '+' : ''}${rule.value})`;
            penaltySelect.appendChild(option);
        });
    }
    
    function updateLeaderboardView() {
        const leaderboardData = tourConfig.teams.map(team => {
            const teamData = scores[team] || { holes: Array(tourConfig.stops.length).fill(0), penalty: 0 };
            const totalHoles = teamData.holes.reduce((a, b) => a + b, 0);
            const total = totalHoles + teamData.penalty;
            return { name: team, holes: teamData.holes, penalty: teamData.penalty, total: total };
        });

        leaderboardData.sort((a, b) => a.total - b.total);

        const leaderboardBody = document.querySelector("#leaderboard tbody");
        leaderboardBody.innerHTML = ''; // Clear existing rows

        leaderboardData.forEach((teamData, index) => {
            const rank = index + 1;
            const row = document.createElement("tr");
            
            let rowHtml = `<td><b>${rank}.</b></td>`; // Rang-Zelle
            rowHtml += `<td class="team-name">${teamData.name}</td>`;
            teamData.holes.forEach(score => {
                rowHtml += `<td>${score > 0 ? score : '-'}</td>`;
            });
            rowHtml += `<td>${teamData.penalty}</td>`;
            rowHtml += `<td class="total">${teamData.total}</td>`;
            
            row.innerHTML = rowHtml;
            leaderboardBody.appendChild(row);
        });
    }

    function updateCurrentStopView(shouldScroll) {
        if (currentStopIndex < 0 || currentStopIndex >= tourConfig.stops.length) {
             document.getElementById('current-challenge-card').style.display = 'none';
             return;
        }
        const stop = tourConfig.stops[currentStopIndex]; const holeNum = currentStopIndex + 1;
        const challengeCard = document.getElementById('current-challenge-card');
        document.getElementById('current-challenge-content').innerHTML = `<h3>Loch ${holeNum}: ${stop.name}</h3><p><strong>Getränk:</strong> ${stop.drink}</p><div class="par">${stop.par}<span>PAR</span></div>`;
        challengeCard.style.display = 'block';
        document.querySelectorAll('.stop').forEach(el => el.classList.remove('active'));
        const activeStopElement = document.getElementById(`stop-list-item-${currentStopIndex}`);
        if(activeStopElement) {
            activeStopElement.classList.add('active');
            if (shouldScroll) activeStopElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        mapMarkers.forEach((marker, index) => {
            const newSize = index === currentStopIndex ? 40 : 30;
            const newAnchor = index === currentStopIndex ? 20 : 15;
            const iconHtml = `<div style="background-color: ${index === currentStopIndex ? 'var(--accent-color)' : 'var(--primary-color)'}; color: ${index === currentStopIndex ? 'black' : 'white'}; border-radius: 50%; width: ${newSize}px; height: ${newSize}px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: ${index === currentStopIndex ? 3 : 2}px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 1000;">${index + 1}</div>`;
            marker.setIcon(L.divIcon({ html: iconHtml, className: '', iconSize: [newSize, newSize], iconAnchor: [newAnchor, newAnchor] }));
        });
    }

    function saveScores() {
        set(ref(db, 'scores'), scores);
    }

    async function loadScores() {
        try {
            const snapshot = await get(ref(db, 'scores'));
            const data = snapshot.val();
            scores = data || {};
        } catch (error) {
            console.error('Fehler beim Laden der Scores:', error);
            scores = {};
        }
        tourConfig.teams.forEach(team => {
            if (!scores[team]) {
                scores[team] = { holes: Array(tourConfig.stops.length).fill(0), penalty: 0 };
            }
        });
        updateLeaderboardView();
    }

    async function loadStopFromStorage() {
        try {
            const snapshot = await get(ref(db, 'currentStop'));
            currentStopIndex = snapshot.val() ?? 0;
            updateCurrentStopView(false);
        } catch (error) {
            console.error('Fehler beim Laden des aktuellen Stops:', error);
            currentStopIndex = 0;
        }
    }

    window.unlockAdmin = function() {
        if (document.getElementById('admin-password').value === tourConfig.adminPassword) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
        } else { alert('Falsches Passwort!'); }
    }

    window.updateScore = function() {
        const selectedTeam = document.getElementById("score-team-select").value;
        const selectedHole = parseInt(document.getElementById("hole-select").value);
        const scoreInput = document.getElementById('score-input');
        const scoreValue = parseInt(scoreInput.value);

        if (selectedTeam && !isNaN(selectedHole) && !isNaN(scoreValue) && scoreValue >= 0) {
            scores[selectedTeam].holes[selectedHole] = scoreValue;
            updateLeaderboardView();
            saveScores();
            scoreInput.value = '';
        } else { alert('Bitte eine gültige Zahl für die Schlücke eintragen.'); }
    }
    
    window.applyPenalty = function() {
        const selectedTeam = document.getElementById("penalty-team-select").value;
        const penaltyValue = parseInt(document.getElementById("penalty-select").value);
        if (selectedTeam && !isNaN(penaltyValue)) {
            scores[selectedTeam].penalty += penaltyValue;
            updateLeaderboardView();
            saveScores();
        }
    }

    window.setCurrentStop = function() {
        const selectedStopIndex = document.getElementById('current-stop-select').value;
        set(ref(db, 'currentStop'), parseInt(selectedStopIndex, 10));
        if (parseInt(selectedStopIndex, 10) !== currentStopIndex) {
             currentStopIndex = parseInt(selectedStopIndex, 10);
             updateCurrentStopView(true);
        }
    }

    window.requestFullReset = function() {
        const resetButton = document.getElementById('reset-button');
        const cancelButton = document.getElementById('cancel-reset-button');

        resetButton.textContent = 'SICHER? NOCHMAL KLICKEN ZUM LÖSCHEN!';
        resetButton.classList.remove('danger-button');
        resetButton.classList.add('confirm-button');
        resetButton.setAttribute('onclick', 'executeFullReset()');

        cancelButton.style.display = 'block';
    }

    window.cancelReset = function() {
        const resetButton = document.getElementById('reset-button');
        const cancelButton = document.getElementById('cancel-reset-button');

        resetButton.textContent = 'ALLES ZURÜCKSETZEN';
        resetButton.classList.remove('confirm-button');
        resetButton.classList.add('danger-button');
        resetButton.setAttribute('onclick', 'requestFullReset()');
        
        cancelButton.style.display = 'none';
    }

    window.executeFullReset = function() {
        set(ref(db, 'scores'), null);
        set(ref(db, 'currentStop'), 0);
        window.location.reload();
    }
</script>

</body>
</html>

